import { Button, VerticalBox, HorizontalBox, LineEdit, CheckBox, ScrollView, TextEdit, ComboBox } from "std-widgets.slint";
import { InputText } from "../../components/input_text.slint";
import { InputNumber } from "../../components/input_number.slint";
import { SelectInput } from "../../components/select_input.slint";

export component NuevoProducto inherits Rectangle {
    // Propiedades de entrada (Asegúrate de llenarlas desde Rust)
    in property <[string]> lista_medidas: ["Unidad", "kg", "g", "L", "ml"]; 
    in property <[string]> lista_empaques: ["Individual", "Caja", "Pack"];
    in property <[string]> lista_marcas: ["Genérico"];
    // Nuevas listas estáticas para categorías y subcategorías
    in property <[string]> lista_categorias: ["General", "Electrónica", "Hogar"];
    in property <[string]> lista_subcategorias: ["Varios", "Limpieza", "Accesorios"];
    
    // Estado de procesamiento para el spinner/bloqueo de UI
    in-out property <bool> procesando: false;
    
// === PROPIEDADES DE VALIDACIÓN DESDE RUST ===
in property <bool> sku-duplicado: false;           // Error de SKU duplicado (desde Rust)
in property <string> mensaje-error: "";            // Mensaje de error general desde Rust

// === VALIDACIÓN DE SKU ===
// La validación de longitud mínima se hace en Rust (más potente con Regex)
// Aquí solo validamos que no esté vacío si el usuario quiere ingresar un SKU

// === ESTADOS DE ERROR LOCALES (Validación visual) ===
// Solo mostrar error si el campo ha sido "tocado" por el usuario
out property <bool> error-nombre: name_in.touched && name_in.text == "";
out property <bool> error-sku: sku_in.touched && (sku_in.text == "" || root.sku-duplicado);
out property <bool> error-costo: p_neto_in.touched && (p_neto_in.text == "" || p_neto_in.text == "0.00");
out property <bool> error-precio: p_venta_in.touched && (p_venta_in.text == "" || p_venta_in.text == "0.00");
out property <bool> error-stock: stock_in.touched && stock_in.text == "";

// === VALIDACIÓN FINANCIERA ===
// La validación financiera detallada se hace en Rust
// Aquí solo verificamos que los campos no estén vacíos o en cero

// Estado general del formulario
// Nota: Ahora solo verificamos que los campos requeridos tengan contenido
// La validación de formato vacío se hace al intentar guardar
out property <bool> formulario-valido: 
    name_in.text != "" && 
    sku_in.text != "" && 
    p_neto_in.text != "" && 
    p_venta_in.text != "" && 
    stock_in.text != "" &&
    root.sku-error-local &&
    !root.sku-duplicado;

// === ESTADO LOCAL DE SKU ===
// Variable local para controlar el estado de error de SKU
out property <bool> sku-error-local: false;

// Callback actualizado (16 parámetros: + categoria_id + subcategoria_id + empaque_id)
callback guardar_producto(string, string, string, string, string, string, string, string, string, string, string, string, string, string, string, string);
callback verificar_sku(string);  // Nuevo callback para verificar SKU duplicado
callback validate-numeric(string, bool, bool) -> string;  // Callback para validación numérica
callback changed(string);  // Callback para limpiar errores al escribir
callback volver();

    background: #0b1018;

    VerticalBox {
        padding: 14px;
        spacing: 10px;
        horizontal-stretch: 1;
        vertical-stretch: 1;

        // --- CABECERA COMPACTA ---
        HorizontalBox {
            alignment: space-between;
            Text {
                text: "REGISTRO TÉCNICO";
                font-size: 20px;
                color: #00ffff;
                font-weight: 800;
            }
            Button {
                text: "Cerrar formulario";
                height: 38px;
                clicked => { root.volver(); }
            }
        }

        form_scroll := ScrollView {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            width: 100%;
            viewport-width: self.visible-width;
            viewport-height: max(self.visible-height, form_content.preferred-height);

            form_content := VerticalBox {
                width: form_scroll.visible-width;
                spacing: 10px;

                Rectangle {
                    background: #121a27;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: #3a4b67;
                    min-height: 58px;
                    VerticalBox {
                        padding: 8px;
                        spacing: 2px;
                        Text {
                            text: "Campos obligatorios: Nombre, Código/SKU, Costo neto, Precio de venta y Stock.";
                            color: #e5ebff;
                            font-size: 12px;
                        }
                        Text {
                            text: "Navegación de escritorio: use Tab/Shift+Tab para recorrer campos y Enter en SKU para validar.";
                            color: #b8c2df;
                            font-size: 11px;
                        }
                    }
                }

                // --- CUERPO EN GRID 2x2 ---
                GridLayout {
                    spacing: 10px;

                    // [0,0] IDENTIFICACIÓN
                    Rectangle {
                        col: 0; row: 0;
                        background: #131b2a; border-radius: 6px;
                border-width: 1px;
                border-color: #33435f;
                VerticalBox {
                    padding: 10px;
                    spacing: 6px;
                    Text { text: "1. IDENTIDAD"; color: #ff79df; font-size: 12px; font-weight: 700; }
                    name_in := InputText { 
                        label: "NOMBRE *"; 
                        placeholder: "Nombre del producto"; 
                        enabled: !root.procesando;
                        has-error: root.error-nombre && name_in.text == "";
                        error-message: "Error: El nombre es requerido";
                    }
sku_in := InputText { 
    label: "CÓDIGO / SKU *"; 
    placeholder: "Ej: ABC-123"; 
    enabled: !root.procesando;
    
    // CAMBIO: Usa 'sku-duplicado' para el estado de error
    has-error: root.sku-duplicado;
    error-message: root.sku-duplicado ? "Error: Este código ya existe" : "";
    
    // Cuando el usuario presiona Enter, verificar SKU
    enter-pressed(sku_text) => {
        root.verificar_sku(sku_text);
    }
    
    // Limpiar error de SKU duplicado cuando el usuario empieza a escribir
    changed(nuevo_texto) => {
        // 1. LIMPIEZA INSTANTÁNEA (Local)
        // Esto desbloquea el 'formulario-valido' en el acto
        root.sku-error-local = true; 
        
        // 2. AVISO A RUST (Segundo plano)
        root.changed(nuevo_texto);
    }
}
                    Text {
                        text: "Nota: el SKU debe ser único. Formato sugerido: ABC-123.";
                        color: #c2cbe2;
                        font-size: 11px;
                    }
                    marca_sel := SelectInput { 
                        label: "MARCA";
                        model: root.lista_marcas;
                        current-index: 0;
                        enabled: !root.procesando;
                    }
                }
                    }

                    // [0,1] CATEGORIZACIÓN Y MEDIDAS
                    Rectangle {
                        col: 1; row: 0;
                        background: #131b2a; border-radius: 6px;
                border-width: 1px;
                border-color: #33435f;
                VerticalBox {
                    padding: 10px;
                    spacing: 6px;
                    Text { text: "2. CATEGORIZACIÓN Y MEDIDAS"; color: #ff79df; font-size: 12px; font-weight: 700; }
                    HorizontalBox {
                        spacing: 6px;
                        cat_sel := SelectInput { 
                            label: "CATEGORÍA";
                            model: root.lista_categorias;
                            current-index: 0;
                            enabled: !root.procesando;
                        }
                        subcat_sel := SelectInput { 
                            label: "SUBCATEGORÍA";
                            model: root.lista_subcategorias;
                            current-index: 0;
                            enabled: !root.procesando;
                        }
                    }
                    HorizontalBox {
                        spacing: 6px;
                        cant_p_in := InputNumber { 
                            label: "CANT. BASE"; 
                            text: "1.0";
                            enabled: !root.procesando; 
                            validate-numeric(text, allow-decimal, allow-negative) => {
                                root.validate-numeric(text, allow-decimal, allow-negative)
                            }
                        }
                        unidad_p_sel := SelectInput { 
                            label: "UNIDAD";
                            model: root.lista_medidas; 
                            current-index: 0; 
                            enabled: !root.procesando;
                        }
                    }
                    HorizontalBox {
                        spacing: 6px;
                        cant_s_in := InputNumber { 
                            label: "CANT. SEC."; 
                            placeholder: "0.0";
                            enabled: !root.procesando; 
                            validate-numeric(text, allow-decimal, allow-negative) => {
                                root.validate-numeric(text, allow-decimal, allow-negative)
                            }
                        }
                        unidad_s_sel := SelectInput { 
                            label: "UNIDAD (OPC)";
                            model: root.lista_medidas; 
                            current-index: -1; 
                            enabled: !root.procesando;
                        }
                    }
                }
                    }

                    // [1,0] FINANZAS Y STOCK
                    Rectangle {
                        col: 0; row: 1;
                        background: #131b2a; border-radius: 6px;
                border-width: 1px;
                border-color: #33435f;
                VerticalBox {
                    padding: 10px;
                    spacing: 6px;
                    Text { text: "3. FINANZAS Y STOCK"; color: #ff79df; font-size: 12px; font-weight: 700; }
                    HorizontalBox {
                        spacing: 6px;
                        p_neto_in := InputNumber { 
                            label: "COSTO NETO *"; 
                            placeholder: "0.00";
                            enabled: !root.procesando;
                            has-error: root.error-costo;
                            error-message: "Error: Ingrese un costo válido";
                            validate-numeric(text, allow-decimal, allow-negative) => {
                                root.validate-numeric(text, allow-decimal, allow-negative)
                            }
                        }
                        p_venta_in := InputNumber { 
                            label: "PRECIO VENTA *"; 
                            placeholder: "0.00";
                            enabled: !root.procesando;
                            has-error: root.error-precio;
                            error-message: "Error: Ingrese un precio válido";
                            validate-numeric(text, allow-decimal, allow-negative) => {
                                root.validate-numeric(text, allow-decimal, allow-negative)
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 6px;
                        stock_in := InputNumber { 
                            label: "STOCK *"; 
                            placeholder: "0";
                            enabled: !root.procesando;
                            has-error: root.error-stock;
                            error-message: "Error: El stock es requerido";
                            validate-numeric(text, allow-decimal, allow-negative) => {
                                root.validate-numeric(text, allow-decimal, allow-negative)
                            }
                        }
                        empaque_sel := SelectInput { 
                            label: "EMPAQUE";
                            model: root.lista_empaques; 
                            current-index: 0;
                            enabled: !root.procesando;
                        }
                    }
                }
                    }

                    // [1,1] DETALLES Y ESTADO
                    Rectangle {
                        col: 1; row: 1;
                        background: #131b2a; border-radius: 6px;
                border-width: 1px;
                border-color: #33435f;
                VerticalBox {
                    padding: 10px;
                    spacing: 6px;
                    Text { text: "4. DESCRIPCIÓN"; color: #ff79df; font-size: 12px; font-weight: 700; }
                    Rectangle {
                        border-width: desc_in.has-focus ? 2px : 1px;
                        border-color: desc_in.has-focus ? #00d4ff : #5b6480;
                        border-radius: 4px;
                        background: #171b29;
                        vertical-stretch: 1;
                        min-height: 96px;
                        desc_in := TextEdit { 
                            placeholder-text: "Descripción del producto..."; 
                            font-size: 13px; 
                            vertical-stretch: 1;
                            enabled: !root.procesando;
                            width: parent.width;
                            height: parent.height;
                        }
                    }
                    HorizontalBox {
                        spacing: 6px;
                        Text { text: "Estado del producto"; color: #ffffff; font-size: 12px; vertical-alignment: center; }
                        activo_check := CheckBox { text: ""; checked: true; enabled: !root.procesando; }
                        Text {
                            text: activo_check.checked ? "Activo" : "Inactivo";
                            color: #ffffff;
                            font-size: 12px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        activo_switch := TouchArea {
                            width: 52px; height: 28px;
                            
                            Rectangle {
                                width: 52px; height: 28px;
                                background: activo_check.checked ? #1f9d55 : #4b5568;
                                border-radius: 14px;
                                border-width: 1px;
                                border-color: #d3d8e5;
                                
                                Rectangle {
                                    x: activo_check.checked ? 28px : 2px;
                                    y: 2px; width: 24px; height: 24px;
                                    background: #fff;
                                    border-radius: 12px;
                                    animate x { duration: 150ms; }
                                }
                            }
                            
                            clicked => { 
                                if (!root.procesando) {
                                    activo_check.checked = !activo_check.checked; 
                                }
                            }
                        }
                    }
                }
                    }
                }
            }
        }

        // --- MENSAJE DE ERROR GENERAL ---
        if (root.mensaje-error != "") : Rectangle {
            background: #3a1116;
            border-radius: 6px;
            border-width: 1px;
            border-color: #ff6b6b;
            height: 44px;
             
            HorizontalBox {
                padding: 8px;
                spacing: 6px;
                
                Text {
                    text: "ERROR";
                    color: #ff4444;
                    font-size: 12px;
                    font-weight: 700;
                }
                Text {
                    text: root.mensaje-error;
                    color: #ffd3d3;
                    font-size: 12px;
                    vertical-alignment: center;
                }
            }
        }

Text {
    text: root.formulario-valido ? "Formulario listo para guardar." :
          "Complete los campos obligatorios marcados con * para habilitar el botón Guardar.";
    color: root.formulario-valido ? #9ef7c3 : #d8e1ff;
    font-size: 12px;
}

// --- BOTÓN ACCIÓN ---
Button {
    text: root.procesando ? "PROCESANDO..." : "GUARDAR PRODUCTO";
    enabled: !root.procesando && root.formulario-valido;
    primary: true;
    height: 44px;
    clicked => {
        // Validación visual antes de enviar
        if (root.formulario-valido) {
            root.guardar_producto(
                name_in.text, p_neto_in.text, p_venta_in.text, stock_in.text,
                desc_in.text, cant_p_in.text, 
                "" + (unidad_p_sel.current-index + 1),
                cant_s_in.text,
                (unidad_s_sel.current-index == -1 ? "" : "" + (unidad_s_sel.current-index + 1)),
                sku_in.text,
                "", // fecha_vencimiento (pendiente de campo UI)
                activo_check.checked ? "true" : "false",
                "" + (marca_sel.current-index + 1),
                "" + (cat_sel.current-index + 1),     // 14. categoria_id
                "" + (subcat_sel.current-index + 1),  // 15. subcategoria_id
                "" + (empaque_sel.current-index + 1)  // 16. empaque_id
            );
        }
    }
}

    }

    // --- CAPA DE BLOQUEO (OVERLAY) ---
    if (root.procesando) : Rectangle {
        background: #000000aa; // Negro semitransparente
        border-radius: 4px;
        
        VerticalBox {
            alignment: center;
            spacing: 15px;
            
            // Indicador de carga simple
            Rectangle {
                width: 60px;
                height: 60px;
                border-radius: 30px;
                background: #1a1a2e;
                border-width: 4px;
                border-color: #00ffff;
                
                // Punto interior
                Rectangle {
                    x: 26px;
                    y: 5px;
                    width: 8px;
                    height: 8px;
                    border-radius: 4px;
                    background: #00ffff;
                }
            }
            
            Text {
                text: "Guardando...";
                color: #00ffff;
                font-size: 16px;
                font-weight: 700;
            }
        }
    }
}
