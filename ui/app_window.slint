import { Button, VerticalBox, HorizontalBox, StandardTableView } from "std-widgets.slint";
import { LoginView } from "views/login_view.slint";
import { NuevoProducto } from "views/producto/nuevo_producto.slint";
import { ListaProductos } from "views/producto/lista_productos.slint";
import { DashboardView } from "views/dashboard_view.slint";

export component AppWindow inherits Window {
    title: "Bodex v1.0 - Gestión de Inventario";
    preferred-width: 1000px;
    preferred-height: 750px;
    min-width: 800px;
    min-height: 600px;
    background: #0a0a0f;

    // ==========================================
    // PROPIEDADES DE ESTADO
    // ==========================================
    
    // Navegación principal: "login" o "dashboard"
    in-out property <string> current-view: "login"; 
    
    // Navegación interna: "inicio", "lista", "nuevo"
    in-out property <string> product-screen: "inicio"; 

    // Datos de la tabla de inventario
    in-out property <[[StandardListViewItem]]> inventory-rows;
    
    // Cálculo automático para el Dashboard
    property <int> total-products: inventory-rows.length;

    // Propiedades para edición (Sincronizadas con Rust)
    in-out property <int> edit-product-id;
    in-out property <string> edit-product-name;
    in-out property <string> edit-product-precio-venta;
    in-out property <string> edit-product-stock;
    
    // Estado de procesamiento para el spinner
    in-out property <bool> procesando: false;
    
    // === PROPIEDADES DE VALIDACIÓN ===
    in-out property <bool> sku-duplicado: false;        // Error de SKU duplicado (desde Rust)
    in-out property <string> mensaje-error: "";         // Mensaje de error general

    // ==========================================
    // CALLBACKS (Puente con Rust)
    // ==========================================
    
    callback attempt-login(string, string);
    callback logout();
    
    callback add-product(string, string, string, string, string, string, string, string, string, string, string, string, string, string, string, string);
    callback delete-product(int);
    callback get-product-for-edit(int);
    callback refresh-inventory();
    callback close-app();
    callback verificar-sku(string);  // Nuevo callback para verificar SKU duplicado
    callback validate-numeric(string, bool, bool) -> string;  // Callback para validación numérica
    callback changed(string);  // Callback para limpiar errores de SKU al escribir

    // ==========================================
    // ESTRUCTURA VISUAL PRINCIPAL
    // ==========================================

    Rectangle {
        width: 100%;
        height: 100%;
        background: @radial-gradient(circle, #1a1a2e 0%, #0a0a0f 100%);

        // --- PANTALLA DE ACCESO (LOGIN) ---
        if (current-view == "login") : LoginView {
            loginSuccessful => { 
                root.attempt-login(self.username, self.password);
            }
        }

        // --- INTERFAZ POST-LOGIN ---
        if (current-view == "dashboard") : VerticalBox {
            padding: 30px;
            spacing: 20px;

            // Barra Superior de Navegación
            HorizontalBox {
                alignment: space-between;
                VerticalBox {
                    spacing: 0px;
                    Text {
                        text: "BODEX :: CONTROL PANEL";
                        color: #00ffff;
                        font-size: 18px;
                        font-weight: 900;
                    }
                    Text {
                        text: product-screen == "inicio" ? "Resumen General" : 
                              product-screen == "lista" ? "Inventario Detallado" : "Registro de Suministros";
                        color: #888;
                        font-size: 12px;
                    }
                }
                
                HorizontalBox {
                    spacing: 15px;
                    // Botón para volver al Dashboard desde cualquier sub-pantalla
                    if (product-screen != "inicio") : Button {
                        text: "INICIO";
                        clicked => { root.product-screen = "inicio"; }
                    }
                    Button {
                        text: "SALIR";
                        clicked => { root.logout(); }
                    }
                }
            }

            // Separador Neon
            Rectangle {
                height: 1px;
                background: @linear-gradient(90deg, #00ffff00 0%, #00ffff 50%, #00ffff00 100%);
                opacity: 0.3;
            }

            // --- ÁREA DE CONTENIDO DINÁMICO ---
            
            // 1. DASHBOARD DE TARJETAS (ESTILO HOME ASSISTANT)
            if (product-screen == "inicio") : DashboardView {
                total-products: root.total-products;
                ir-a-lista => { 
                    root.product-screen = "lista";
                    root.refresh-inventory(); 
                }
            }

            // 2. LISTA DE PRODUCTOS
            if (product-screen == "lista") : ListaProductos {
                rows: root.inventory-rows;
                
                ir_a_nuevo => { 
                    root.product-screen = "nuevo"; 
                }
                
                refrescar => { 
                    root.refresh-inventory(); 
                }
            }

            // 3. FORMULARIO DE NUEVO PRODUCTO
            if (product-screen == "nuevo") : NuevoProducto {
                procesando: root.procesando;
                sku-duplicado: root.sku-duplicado;
                mensaje-error: root.mensaje-error;
                
                volver => { 
                    // Limpiar errores al volver
                    root.sku-duplicado = false;
                    root.mensaje-error = "";
                    root.product-screen = "lista"; 
                }
                
                verificar_sku(sku) => {
                    root.verificar-sku(sku);
                }
                
                validate-numeric(text, allow-decimal, allow-negative) => {
                    root.validate-numeric(text, allow-decimal, allow-negative)
                }

                changed(texto) => {
                    root.changed(texto);
                }
                
                guardar_producto(nombre, p_neto, p_venta, stock, desc, peso, tam, u_med, pres, cod, venc, activo, m_id, cat_id, subcat_id, empaque_id) => {
                    root.add-product(
                        nombre, p_neto, p_venta, stock, 
                        desc, peso, tam, u_med, pres, cod, 
                        venc, activo, m_id, cat_id, subcat_id, empaque_id
                    );
                    // Nota: El cambio de pantalla se hace desde Rust después de completar
                }
            }
        }
    }
}
