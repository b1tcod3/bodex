import { Button, VerticalBox, HorizontalBox, StandardTableView } from "std-widgets.slint";
import { LoginView } from "views/login_view.slint";
import { NuevoProducto } from "views/producto/nuevo_producto.slint";
import { ListaProductos } from "views/producto/lista_productos.slint";
import { DashboardView } from "views/dashboard_view.slint";

export component AppWindow inherits Window {
    title: "Bodex v1.0 - Gesti贸n de Inventario";
    width: 1000px;
    height: 750px;
    background: #0a0a0f;
    maximizable: true;
    resizable: true;

    // ==========================================
    // PROPIEDADES DE ESTADO
    // ==========================================
    
    // Navegaci贸n principal: "login" o "dashboard"
    in-out property <string> current-view: "login"; 
    
    // Navegaci贸n interna: "inicio", "lista", "nuevo"
    in-out property <string> product-screen: "inicio"; 

    // Datos de la tabla de inventario
    in-out property <[[StandardListViewItem]]> inventory-rows;
    
    // C谩lculo autom谩tico para el Dashboard
    property <int> total-products: inventory-rows.length;

    // Propiedades para edici贸n (Sincronizadas con Rust)
    in-out property <int> edit-product-id;
    in-out property <string> edit-product-name;
    in-out property <string> edit-product-precio-venta;
    in-out property <string> edit-product-stock;

    // ==========================================
    // CALLBACKS (Puente con Rust)
    // ==========================================
    
    callback attempt-login(string, string);
    callback logout();
    
    callback add-product(
        string, string, string, string, string, 
        string, string, string, string, string, 
        bool, string, string
    );
    callback delete-product(int);
    callback get-product-for-edit(int);
    callback refresh-inventory();
    callback close-app();

    // ==========================================
    // ESTRUCTURA VISUAL PRINCIPAL
    // ==========================================

    Rectangle {
        width: 100%;
        height: 100%;
        background: @radial-gradient(circle, #1a1a2e 0%, #0a0a0f 100%);

        // --- PANTALLA DE ACCESO (LOGIN) ---
        if (current-view == "login") : LoginView {
            loginSuccessful => { 
                root.attempt-login(self.username, self.password);
            }
        }

        // --- INTERFAZ POST-LOGIN ---
        if (current-view == "dashboard") : VerticalBox {
            padding: 30px;
            spacing: 20px;

            // Barra Superior de Navegaci贸n
            HorizontalBox {
                alignment: space-between;
                VerticalBox {
                    spacing: 0px;
                    Text {
                        text: "BODEX :: CONTROL PANEL";
                        color: #00ffff;
                        font-size: 18px;
                        font-weight: 900;
                    }
                    Text {
                        text: product-screen == "inicio" ? "Resumen General" : 
                              product-screen == "lista" ? "Inventario Detallado" : "Registro de Suministros";
                        color: #888;
                        font-size: 12px;
                    }
                }
                
                HorizontalBox {
                    spacing: 15px;
                    // Bot贸n para volver al Dashboard desde cualquier sub-pantalla
                    if (product-screen != "inicio") : Button {
                        text: " INICIO";
                        clicked => { root.product-screen = "inicio"; }
                    }
                    Button {
                        text: "SALIR";
                        clicked => { root.logout(); }
                    }
                }
            }

            // Separador Neon
            Rectangle {
                height: 1px;
                background: @linear-gradient(90deg, #00ffff00 0%, #00ffff 50%, #00ffff00 100%);
                opacity: 0.3;
            }

            // --- REA DE CONTENIDO DINMICO ---
            
            // 1. DASHBOARD DE TARJETAS (ESTILO HOME ASSISTANT)
            if (product-screen == "inicio") : DashboardView {
                total-products: root.total-products;
                ir-a-lista => { 
                    root.product-screen = "lista";
                    root.refresh-inventory(); 
                }
            }

            // 2. LISTA DE PRODUCTOS
            if (product-screen == "lista") : ListaProductos {
                rows: root.inventory-rows;
                
                ir_a_nuevo => { 
                    root.product-screen = "nuevo"; 
                }
                
                refrescar => { 
                    root.refresh-inventory(); 
                }
            }

            // 3. FORMULARIO DE NUEVO PRODUCTO
            if (product-screen == "nuevo") : NuevoProducto {
                volver => { 
                    root.product-screen = "lista"; 
                }
                
                guardar_producto(nombre, p_venta, stock, sku, peso, venc, m_id) => {
                    root.add-product(
                        nombre, "0.0", p_venta, stock, "", 
                        peso, "", "", "", sku, 
                        true, venc, m_id
                    );
                    // Regresar a la lista tras guardar
                    root.product-screen = "lista";
                }
            }
        }
    }
}
